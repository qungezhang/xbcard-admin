@layout("/common/_container.html"){
<style>

    .node {
        cursor: pointer;
    }

    .node circle {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 1.5px;
    }

    .node text {
        font: 10px sans-serif;
    }

    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
    }

    .tree {
        width: 1400px;
        height: 800px;
        margin: 0 auto;
        /*background: #E0E0E0;*/
    }

    .tree svg {
        width: 100%;
        height: 100%;
    }

</style>
<div class="row">
    <div class="tree" id="tree"></div>
</div>

<script type="text/javascript" src="../../../../static/spacetree/js/d3.v3.min.js"></script>
<script>
    var json =[];
    $(function () {
        var ajax = new $ax(Feng.ctxPath + "/wxUser/spaceTreeUsersData", function (data) {
            json=data;
            // alert(JSON.stringify(data));
            // alert(JSON.stringify(json));
            var margin = [20, 120, 20, 120],
                width = document.getElementById("tree").offsetWidth,
                height = document.getElementById("tree").offsetHeight;

            var i = 0,
                duration = 750,
                root;

            var tree = d3.layout.tree()
                .size([height, width]);

            var diagonal = d3.svg.diagonal()
                .projection(function (d) {
                    return [d.y, d.x];
                });

            var zoom = d3.behavior.zoom().scaleExtent([0.1, 100]).on("zoom", zoomed);//添加放大缩小事件

            var svg = d3.select("body").select("#tree").append("svg")
                .call(zoom)//给svg绑定zoom事件
                .append("g")
                .call(zoom)//给g绑定zoom事件
                .append("g")
                .attr("transform", "translate(" + margin[3] + "," + margin[0] + ")");


            root = json[0];
            // root = json;
            root.x0 = height / 2;
            root.y0 = 0;

            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }

            root.children.forEach(collapse);
            update(root);

            function zoomed() {
                svg.attr("transform",
                    "translate(" + zoom.translate() + ")" +
                    "scale(" + zoom.scale() + ")"
                );
            }

            function update(source) {

                // Compute the new tree layout.
                var nodes = tree.nodes(root).reverse(),
                    links = tree.links(nodes);

                // Normalize for fixed-depth.
                nodes.forEach(function (d) {
                    d.y = d.depth * 180;
                });

                // Update the nodes…
                var node = svg.selectAll("g.node")
                    .data(nodes, function (d) {
                        return d.id || (d.id = ++i);
                    });

                // Enter any new nodes at the parent's previous position.
                var nodeEnter = node.enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function (d) {
                        return "translate(" + source.y0 + "," + source.x0 + ")";
                    })
                    .on("click", click);

                nodeEnter.append("circle")
                    .attr("r", 1e-6)
                    // .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });
                    .style("fill", function (d) {
                        return d._children ? "#f00" : "#fff";
                    });
                //文字 1
                // nodeEnter.append("text")
                //     .attr("x", function (d) {
                //         return d.children || d._children ? 50 : 30;
                //     })
                //     .attr("dy", ".35em")
                //     .attr("text-anchor", function (d) {
                //         return d.children || d._children ? "end" : "start";
                //     })
                //     .text(function (d) {
                //         return d.name;
                //     })
                //     .style("fill-opacity", 1)
                //     .style("font-size", "12px");
                nodeEnter.append("text")
                    .attr("x", function (d) {
                        return d.children || d._children ? -10 : 10;
                    })
                    .attr("dy", ".35em")
                    .attr("text-anchor", function (d) {
                        return d.children || d._children ? "end" : "start";
                    })
                    .text(function (d) {
                        // return d.data.nickName+"("+d.data.vipNum+
                        //     "-"+d.data.childCount+")";
                        return d.name+"("+d.data.vipNum+
                            "-"+d.data.childCount+")";
                    })
                    .style("fill-opacity", 1);

                var nodeUpdate = node.transition()
                    .duration(duration)
                    .attr("transform", function (d) {
                        return "translate(" + d.y + "," + d.x + ")";
                    });

                nodeUpdate.select("circle")
                    .attr("r", 4.5)
                    // .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });
                    .style("fill", function (d) {
                        return d._children ? "#f00" : "#f90";
                    });
                nodeUpdate.select("text")
                    .style("fill-opacity", 1);

                var nodeExit = node.exit().transition()
                    .duration(duration)
                    .attr("transform", function (d) {
                        return "translate(" + source.y + "," + source.x + ")";
                    })
                    .remove();

                nodeExit.select("circle")
                    .attr("r", 1e-6);

                nodeExit.select("text")
                    .style("fill-opacity", 1e-6);

                var link = svg.selectAll("path.link")
                    .data(links, function (d) {
                        return d.target.id;
                    });

                link.enter().insert("path", "g")
                    .attr("class", "link")
                    .attr("d", function (d) {
                        var o = {x: source.x0, y: source.y0};
                        return diagonal({source: o, target: o});
                    });

                link.transition()
                    .duration(duration)
                    .attr("d", diagonal);

                link.exit().transition()
                    .duration(duration)
                    .attr("d", function (d) {
                        var o = {x: source.x, y: source.y};
                        return diagonal({source: o, target: o});
                    })
                    .remove();

                nodes.forEach(function (d) {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }

            function click(d) {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                } else {
                    d.children = d._children;
                    d._children = null;
                }
                update(d);
            }
        }, function (data) {

        });
        ajax.start();
    })

    // alert(JSON.stringify(json));


</script>
@}
